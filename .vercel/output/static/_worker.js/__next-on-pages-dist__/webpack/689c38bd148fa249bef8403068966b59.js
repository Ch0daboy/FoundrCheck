var x={},L=(v,R,_)=>(x.__chunk_4325=(U,y,b)=>{"use strict";b.d(y,{Gl:()=>n,WI:()=>p,kS:()=>u,ye:()=>a});var f=b(7766),S=b(3611),g=b(129);async function l(o){let c=new TextEncoder().encode(o);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",c))).map(r=>r.toString(16).padStart(2,"0")).join("")}async function E(o,c){return await l(c)===o}function d(o){let c=new S.rs(o.DB,{user:"user",session:"session"});return new f.aF(c,{sessionExpiresIn:new f.i9(30,"d"),sessionCookie:{name:"fc_session",attributes:{sameSite:"lax",secure:!0,path:"/"}}})}async function n(o,c){let r=d(o),t=c.headers.get("cookie")??"",e=r.readSessionCookie(t);return e?await r.validateSession(e):{user:null,session:null}}async function a(o,c,r){if(await o.DB.prepare("SELECT id FROM user WHERE email = ?").bind(c).first())throw Error("EMAIL_TAKEN");let t=(0,g.Z)();await o.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(t,c).run();let e=await l(r),s=`email:${c}`;await o.DB.prepare("INSERT INTO key (id, user_id, hashed_password) VALUES (?, ?, ?)").bind(s,t,e).run(),await o.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(t,c).run();let i=d(o),h=await i.createSession(t,{});return{userId:t,cookie:i.createSessionCookie(h.id).serialize()}}async function p(o,c,r){let t=`email:${c}`,e=await o.DB.prepare("SELECT user_id, hashed_password FROM key WHERE id = ?").bind(t).first();if(!e||!await E(e.hashed_password,r))throw Error("INVALID_CREDENTIALS");let s=d(o),i=await s.createSession(e.user_id,{}),h=s.createSessionCookie(i.id).serialize();return{userId:e.user_id,cookie:h}}async function u(o,c){let r=d(o),t=c.headers.get("cookie")??"",e=r.readSessionCookie(t);return e&&await r.invalidateSession(e),r.createBlankSessionCookie().serialize()}},x.__chunk_7766=(U,y,b)=>{var f,S,g,l;b.d(y,{aF:()=>c,i9:()=>E});class E{constructor(t,e){this.value=t,this.unit=e}value;unit;milliseconds(){return this.unit==="ms"?this.value:this.unit==="s"?1e3*this.value:this.unit==="m"?6e4*this.value:this.unit==="h"?36e5*this.value:this.unit==="d"?864e5*this.value:6048e5*this.value}seconds(){return this.milliseconds()/1e3}transform(t){return new E(Math.round(this.milliseconds()*t),"ms")}}function d(r){return Date.now()<r.getTime()}function n(r){return new Date(Date.now()+r.milliseconds())}class a{constructor(t,e,s){this.cookieName=t,this.cookieExpiresIn=s?.expiresIn??null,this.baseCookieAttributes=e}cookieName;cookieExpiresIn;baseCookieAttributes;createCookie(t){return new p(this.cookieName,t,{...this.baseCookieAttributes,maxAge:this.cookieExpiresIn?.seconds()})}createBlankCookie(){return new p(this.cookieName,"",{...this.baseCookieAttributes,maxAge:0})}parse(t){return function(e){let s=new Map;for(let i of e.split("; ")){let h=i.split("="),w=h[0],N=h[1]??"";w&&s.set(decodeURIComponent(w),decodeURIComponent(N))}return s}(t).get(this.cookieName)??null}}class p{constructor(t,e,s){this.name=t,this.value=e,this.attributes=s}name;value;attributes;serialize(){return function(t,e,s){let i=[];return i.push([encodeURIComponent(t),encodeURIComponent(e)]),s?.domain!==void 0&&i.push(["Domain",s.domain]),s?.expires!==void 0&&i.push(["Expires",s.expires.toUTCString()]),s?.httpOnly&&i.push(["HttpOnly"]),s?.maxAge!==void 0&&i.push(["Max-Age",s.maxAge.toString()]),s?.path!==void 0&&i.push(["Path",s.path]),s?.sameSite==="lax"&&i.push(["SameSite","Lax"]),s?.sameSite==="none"&&i.push(["SameSite","None"]),s?.sameSite==="strict"&&i.push(["SameSite","Strict"]),s?.secure&&i.push(["Secure"]),i.map(h=>h.join("=")).join("; ")}(this.name,this.value,this.attributes)}}(function(r){r[r.Include=0]="Include",r[r.None=1]="None"})(f||(f={})),function(r){r[r.Required=0]="Required",r[r.Ignore=1]="Ignore"}(S||(S={})),function(r){r[r.Include=0]="Include",r[r.None=1]="None"}(g||(g={})),function(r){r[r.Required=0]="Required",r[r.Ignore=1]="Ignore"}(l||(l={}));class u{uint8(t,e){if(t.byteLength<e+1)throw TypeError("Insufficient bytes");return t[e]}uint16(t,e){if(t.byteLength<e+2)throw TypeError("Insufficient bytes");return t[e]<<8|t[e+1]}uint32(t,e){if(t.byteLength<e+4)throw TypeError("Insufficient bytes");let s=0;for(let i=0;i<4;i++)s|=t[e+i]<<24-8*i;return s}uint64(t,e){if(t.byteLength<e+8)throw TypeError("Insufficient bytes");let s=0n;for(let i=0;i<8;i++)s|=BigInt(t[e+i])<<BigInt(56-8*i);return s}putUint8(t,e,s){if(t.length<s+1)throw TypeError("Not enough space");if(e<0||e>255)throw TypeError("Invalid uint8 value");t[s]=e}putUint16(t,e,s){if(t.length<s+2)throw TypeError("Not enough space");if(e<0||e>65535)throw TypeError("Invalid uint16 value");t[s]=e>>8,t[s+1]=255&e}putUint32(t,e,s){if(t.length<s+4)throw TypeError("Not enough space");if(e<0||e>4294967295)throw TypeError("Invalid uint32 value");for(let i=0;i<4;i++)t[s+i]=e>>(3-i)*8&255}putUint64(t,e,s){if(t.length<s+8)throw TypeError("Not enough space");if(e<0||e>0xffffffffffffffffn)throw TypeError("Invalid uint64 value");for(let i=0;i<8;i++)t[s+i]=Number(e>>BigInt((7-i)*8)&255n)}}class o{uint8(t,e){if(t.byteLength<e+1)throw TypeError("Insufficient bytes");return t[e]}uint16(t,e){if(t.byteLength<e+2)throw TypeError("Insufficient bytes");return t[e]|t[e+1]<<8}uint32(t,e){if(t.byteLength<e+4)throw TypeError("Insufficient bytes");let s=0;for(let i=0;i<4;i++)s|=t[e+i]<<8*i;return s}uint64(t,e){if(t.byteLength<e+8)throw TypeError("Insufficient bytes");let s=0n;for(let i=0;i<8;i++)s|=BigInt(t[e+i])<<BigInt(8*i);return s}putUint8(t,e,s){if(t.length<1+s)throw TypeError("Insufficient space");if(e<0||e>255)throw TypeError("Invalid uint8 value");t[s]=e}putUint16(t,e,s){if(t.length<2+s)throw TypeError("Insufficient space");if(e<0||e>65535)throw TypeError("Invalid uint16 value");t[s+1]=e>>8,t[s]=255&e}putUint32(t,e,s){if(t.length<4+s)throw TypeError("Insufficient space");if(e<0||e>4294967295)throw TypeError("Invalid uint32 value");for(let i=0;i<4;i++)t[s+i]=e>>8*i&255}putUint64(t,e,s){if(t.length<8+s)throw TypeError("Insufficient space");if(e<0||e>0xffffffffffffffffn)throw TypeError("Invalid uint64 value");for(let i=0;i<8;i++)t[s+i]=Number(e>>BigInt(8*i)&255n)}}new u,new o;class c{adapter;sessionExpiresIn;sessionCookieController;getSessionAttributes;getUserAttributes;sessionCookieName;constructor(t,e){this.adapter=t,this.getUserAttributes=h=>e&&e.getUserAttributes?e.getUserAttributes(h):{},this.getSessionAttributes=h=>e&&e.getSessionAttributes?e.getSessionAttributes(h):{},this.sessionExpiresIn=e?.sessionExpiresIn??new E(30,"d"),this.sessionCookieName=e?.sessionCookie?.name??"auth_session";let s=this.sessionExpiresIn;e?.sessionCookie?.expires===!1&&(s=new E(400,"d"));let i={httpOnly:!0,secure:!0,sameSite:"lax",path:"/",...e?.sessionCookie?.attributes};this.sessionCookieController=new a(this.sessionCookieName,i,{expiresIn:s})}async getUserSessions(t){let e=await this.adapter.getUserSessions(t),s=[];for(let i of e)d(i.expiresAt)&&s.push({id:i.id,expiresAt:i.expiresAt,userId:i.userId,fresh:!1,...this.getSessionAttributes(i.attributes)});return s}async validateSession(t){let[e,s]=await this.adapter.getSessionAndUser(t);if(!e)return{session:null,user:null};if(!s||!d(e.expiresAt))return await this.adapter.deleteSession(e.id),{session:null,user:null};let i=new Date(e.expiresAt.getTime()-this.sessionExpiresIn.milliseconds()/2),h={...this.getSessionAttributes(e.attributes),id:e.id,userId:e.userId,fresh:!1,expiresAt:e.expiresAt};return d(i)||(h.fresh=!0,h.expiresAt=n(this.sessionExpiresIn),await this.adapter.updateSessionExpiration(e.id,h.expiresAt)),{user:{...this.getUserAttributes(s.attributes),id:s.id},session:h}}async createSession(t,e,s){let i=s?.sessionId??function(w,N,C){let k="";for(let A=0;A<w.byteLength;A+=5){let T=0n,m=0;for(let I=0;I<5&&A+I<w.byteLength;I++)T=T<<8n|BigInt(w[A+I]),m+=8;m%5!=0&&(T<<=BigInt(5-m%5),m+=5-m%5);for(let I=0;I<8;I++)m>=5?(k+=N[Number(T>>BigInt(m-5)&31n)],m-=5):m>0?(k+=N[Number(T<<BigInt(6-m)&63n)],m=0):C===f.Include&&(k+="=")}return k}(crypto.getRandomValues(new Uint8Array(25)),"abcdefghijklmnopqrstuvwxyz234567",f.None),h=n(this.sessionExpiresIn);return await this.adapter.setSession({id:i,userId:t,expiresAt:h,attributes:e}),{id:i,userId:t,fresh:!0,expiresAt:h,...this.getSessionAttributes(e)}}async invalidateSession(t){await this.adapter.deleteSession(t)}async invalidateUserSessions(t){await this.adapter.deleteUserSessions(t)}async deleteExpiredSessions(){await this.adapter.deleteExpiredSessions()}readSessionCookie(t){return this.sessionCookieController.parse(t)}readBearerToken(t){let[e,s]=t.split(" ");return e!=="Bearer"?null:s??null}createSessionCookie(t){return this.sessionCookieController.createCookie(t)}createBlankSessionCookie(){return this.sessionCookieController.createBlankCookie()}}},x.__chunk_3611=(U,y,b)=>{b.d(y,{rs:()=>l});class f{controller;escapedUserTableName;escapedSessionTableName;constructor(n,a){this.controller=n,this.escapedSessionTableName=g(a.session),this.escapedUserTableName=g(a.user)}async deleteSession(n){await this.controller.execute(`DELETE FROM ${this.escapedSessionTableName} WHERE id = ?`,[n])}async deleteUserSessions(n){await this.controller.execute(`DELETE FROM ${this.escapedSessionTableName} WHERE user_id = ?`,[n])}async getSessionAndUser(n){let[a,p]=await Promise.all([this.getSession(n),this.getUserFromSessionId(n)]);return[a,p]}async getUserSessions(n){return(await this.controller.getAll(`SELECT * FROM ${this.escapedSessionTableName} WHERE user_id = ?`,[n])).map(a=>S(a))}async setSession(n){let a=Object.entries({id:n.id,user_id:n.userId,expires_at:Math.floor(n.expiresAt.getTime()/1e3),...n.attributes}).filter(([c,r])=>r!==void 0),p=a.map(([c])=>g(c)),u=Array(p.length).fill("?"),o=a.map(([c,r])=>r);await this.controller.execute(`INSERT INTO ${this.escapedSessionTableName} (${p.join(", ")}) VALUES (${u.join(", ")})`,o)}async updateSessionExpiration(n,a){await this.controller.execute(`UPDATE ${this.escapedSessionTableName} SET expires_at = ? WHERE id = ?`,[Math.floor(a.getTime()/1e3),n])}async deleteExpiredSessions(){await this.controller.execute(`DELETE FROM ${this.escapedSessionTableName} WHERE expires_at <= ?`,[Math.floor(Date.now()/1e3)])}async getSession(n){let a=await this.controller.get(`SELECT * FROM ${this.escapedSessionTableName} WHERE id = ?`,[n]);return a?S(a):null}async getUserFromSessionId(n){let a=await this.controller.get(`SELECT ${this.escapedUserTableName}.* FROM ${this.escapedSessionTableName} INNER JOIN ${this.escapedUserTableName} ON ${this.escapedUserTableName}.id = ${this.escapedSessionTableName}.user_id WHERE ${this.escapedSessionTableName}.id = ?`,[n]);return a?function(p){let{id:u,...o}=p;return{id:u,attributes:o}}(a):null}}function S(d){let{id:n,user_id:a,expires_at:p,...u}=d;return{userId:a,id:n,expiresAt:new Date(1e3*p),attributes:u}}function g(d){return"`"+d+"`"}class l extends f{constructor(n,a){super(new E(n),a)}}class E{db;constructor(n){this.db=n}async get(n,a){return await this.db.prepare(n).bind(...a).first()}async getAll(n,a){return(await this.db.prepare(n).bind(...a).all()).results??[]}async execute(n,a){await this.db.prepare(n).bind(...a).run()}}},x.__chunk_129=(U,y,b)=>{let f;b.d(y,{Z:()=>E});let S={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},g=new Uint8Array(16),l=[];for(let d=0;d<256;++d)l.push((d+256).toString(16).slice(1));let E=function(d,n,a){if(S.randomUUID&&!n&&!d)return S.randomUUID();let p=(d=d||{}).random||(d.rng||function(){if(!f&&!(f=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return f(g)})();if(p[6]=15&p[6]|64,p[8]=63&p[8]|128,n){a=a||0;for(let u=0;u<16;++u)n[a+u]=p[u];return n}return function(u,o=0){return l[u[o+0]]+l[u[o+1]]+l[u[o+2]]+l[u[o+3]]+"-"+l[u[o+4]]+l[u[o+5]]+"-"+l[u[o+6]]+l[u[o+7]]+"-"+l[u[o+8]]+l[u[o+9]]+"-"+l[u[o+10]]+l[u[o+11]]+l[u[o+12]]+l[u[o+13]]+l[u[o+14]]+l[u[o+15]]}(p)}},x);export{L as __getNamedExports};
