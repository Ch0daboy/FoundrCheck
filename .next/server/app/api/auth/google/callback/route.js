(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[688],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},4573:(e,t,a)=>{"use strict";a.r(t),a.d(t,{ComponentMod:()=>m,default:()=>k});var r={};a.r(r),a.d(r,{GET:()=>h,runtime:()=>p});var i={};a.r(i),a.d(i,{originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>E,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var o=a(6637),n=a(1554),s=a(2130),u=a(7425),l=a(4381),c=a(4325),d=a(9560);let p="edge";async function h(e){let t=(0,l.O)(),a=new URL(e.url),r=a.searchParams.get("code"),i=a.searchParams.get("state"),o=e.headers.get("cookie")??"",n=o.split("; ").find(e=>e.startsWith("google_oauth_state="))?.split("=")[1],s=o.split("; ").find(e=>e.startsWith("google_code_verifier="))?.split("=")[1];if(!r||!i||!n||!s||i!==n)return new Response("Invalid OAuth callback",{status:400});try{let e=(0,c.vt)(t),a=await e.validateAuthorizationCode(r,s),i=(0,d.yD)(a.idToken()),o={email:i.email||"",name:i.name||"",sub:i.sub||""};if(!o.email)throw Error("No email provided by Google");let n=await (0,c.y_)(t,o),{cookie:u}=await (0,c.hE)(t,n),l=`${t.APP_URL||"https://foundrcheck.com"}/profile`;return new Response(null,{status:302,headers:{Location:l,"Set-Cookie":[u,"google_oauth_state=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0","google_code_verifier=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0"].join(", ")}})}catch(e){return new Response(null,{status:302,headers:{Location:`${t.APP_URL||"https://foundrcheck.com"}/?error=oauth_failed`,"Set-Cookie":"google_oauth_state=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0, google_code_verifier=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0"}})}}let E=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/google/callback/route",pathname:"/api/auth/google/callback",filename:"route",bundlePath:"app/api/auth/google/callback/route"},resolvedPagePath:"/home/noob/FoundrCheck/app/api/auth/google/callback/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:S,staticGenerationAsyncStorage:f,serverHooks:_}=E,g="/api/auth/google/callback/route";function w(){return(0,u.XH)({serverHooks:_,staticGenerationAsyncStorage:f})}let m=i,k=o.a.wrap(E)},4381:(e,t,a)=>{"use strict";a.d(t,{O:()=>i});var r=a(6493);function i(){return(0,r.getRequestContext)().env}},4325:(e,t,a)=>{"use strict";a.d(t,{Gl:()=>d,WI:()=>h,hE:()=>f,kS:()=>E,vt:()=>c,y_:()=>S,ye:()=>p});var r=a(2813),i=a(3611),o=a(9560),n=a(129);async function s(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function u(e,t){return await s(t)===e}function l(e){let t=new i.rs(e.DB,{user:"user",session:"session"}),a=(e.APP_URL||"https://foundrcheck.com").includes("foundrcheck.com");return new r.aF(t,{sessionExpiresIn:new r.i9(30,"d"),sessionCookie:{name:"fc_session",attributes:{sameSite:"lax",secure:a,path:"/",domain:a?".foundrcheck.com":void 0}}})}function c(e){if(!e.GOOGLE_CLIENT_ID||!e.GOOGLE_CLIENT_SECRET)throw Error("Google OAuth credentials not configured");let t=`${e.APP_URL||"https://foundrcheck.com"}/api/auth/google/callback`;return new o.ie(e.GOOGLE_CLIENT_ID,e.GOOGLE_CLIENT_SECRET,t)}async function d(e,t){let a=l(e),r=t.headers.get("cookie")??"",i=a.readSessionCookie(r);return i?await a.validateSession(i):{user:null,session:null}}async function p(e,t,a){if(await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t).first())throw Error("EMAIL_TAKEN");let r=(0,n.Z)();await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(r,t).run();let i=await s(a),o=`email:${t}`;await e.DB.prepare("INSERT INTO key (id, user_id, hashed_password) VALUES (?, ?, ?)").bind(o,r,i).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(r,t).run();let u=l(e),c=await u.createSession(r,{});return{userId:r,cookie:u.createSessionCookie(c.id).serialize()}}async function h(e,t,a){let r=`email:${t}`,i=await e.DB.prepare("SELECT user_id, hashed_password FROM key WHERE id = ?").bind(r).first();if(!i||!await u(i.hashed_password,a))throw Error("INVALID_CREDENTIALS");let o=l(e),n=await o.createSession(i.user_id,{}),s=o.createSessionCookie(n.id).serialize();return{userId:i.user_id,cookie:s}}async function E(e,t){let a=l(e),r=t.headers.get("cookie")??"",i=a.readSessionCookie(r);return i&&await a.invalidateSession(i),a.createBlankSessionCookie().serialize()}async function S(e,t){let a=await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t.email).first();if(a)return a.id;let r=(0,n.Z)();return await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(r,t.email).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(r,t.email).run(),r}async function f(e,t){let a=l(e),r=await a.createSession(t,{}),i=a.createSessionCookie(r.id).serialize();return{session:r,cookie:i}}}},e=>{var t=t=>e(e.s=t);e.O(0,[776,481,745],()=>t(4573));var a=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/auth/google/callback/route"]=a}]);
//# sourceMappingURL=route.js.map