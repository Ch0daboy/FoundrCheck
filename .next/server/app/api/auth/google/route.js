(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[718],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},2279:(e,t,r)=>{"use strict";r.r(t),r.d(t,{ComponentMod:()=>m,default:()=>O});var a={};r.r(a),r.d(a,{GET:()=>E,runtime:()=>p});var i={};r.r(i),r.d(i,{originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>h,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var o=r(6637),n=r(1554),s=r(2130),u=r(7425),c=r(4381),d=r(4325),l=r(9560);let p="edge";async function E(){let e=(0,c.O)();try{let t=(0,d.vt)(e),r=(0,l.aV)(),a=(0,l.Uj)(),i=t.createAuthorizationURL(r,a,["openid","email","profile"]);return new Response(null,{status:302,headers:{Location:i.toString(),"Set-Cookie":`google_oauth_state=${r}; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=600, google_code_verifier=${a}; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=600`}})}catch(e){return new Response("OAuth configuration error",{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/google/route",pathname:"/api/auth/google",filename:"route",bundlePath:"app/api/auth/google/route"},resolvedPagePath:"/home/noob/FoundrCheck/app/api/auth/google/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:f,serverHooks:_}=h,g="/api/auth/google/route";function w(){return(0,u.XH)({serverHooks:_,staticGenerationAsyncStorage:f})}let m=i,O=o.a.wrap(h)},4381:(e,t,r)=>{"use strict";r.d(t,{O:()=>i});var a=r(6493);function i(){return(0,a.getRequestContext)().env}},4325:(e,t,r)=>{"use strict";r.d(t,{Gl:()=>l,WI:()=>E,hE:()=>f,kS:()=>h,vt:()=>d,y_:()=>S,ye:()=>p});var a=r(2813),i=r(3611),o=r(9560),n=r(129);async function s(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function u(e,t){return await s(t)===e}function c(e){let t=new i.rs(e.DB,{user:"user",session:"session"}),r=(e.APP_URL||"https://foundrcheck.com").includes("foundrcheck.com");return new a.aF(t,{sessionExpiresIn:new a.i9(30,"d"),sessionCookie:{name:"fc_session",attributes:{sameSite:"lax",secure:r,path:"/",domain:r?".foundrcheck.com":void 0}}})}function d(e){if(!e.GOOGLE_CLIENT_ID||!e.GOOGLE_CLIENT_SECRET)throw Error("Google OAuth credentials not configured");let t=`${e.APP_URL||"https://foundrcheck.com"}/api/auth/google/callback`;return new o.ie(e.GOOGLE_CLIENT_ID,e.GOOGLE_CLIENT_SECRET,t)}async function l(e,t){let r=c(e),a=t.headers.get("cookie")??"",i=r.readSessionCookie(a);return i?await r.validateSession(i):{user:null,session:null}}async function p(e,t,r){if(await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t).first())throw Error("EMAIL_TAKEN");let a=(0,n.Z)();await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(a,t).run();let i=await s(r),o=`email:${t}`;await e.DB.prepare("INSERT INTO key (id, user_id, hashed_password) VALUES (?, ?, ?)").bind(o,a,i).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(a,t).run();let u=c(e),d=await u.createSession(a,{});return{userId:a,cookie:u.createSessionCookie(d.id).serialize()}}async function E(e,t,r){let a=`email:${t}`,i=await e.DB.prepare("SELECT user_id, hashed_password FROM key WHERE id = ?").bind(a).first();if(!i||!await u(i.hashed_password,r))throw Error("INVALID_CREDENTIALS");let o=c(e),n=await o.createSession(i.user_id,{}),s=o.createSessionCookie(n.id).serialize();return{userId:i.user_id,cookie:s}}async function h(e,t){let r=c(e),a=t.headers.get("cookie")??"",i=r.readSessionCookie(a);return i&&await r.invalidateSession(i),r.createBlankSessionCookie().serialize()}async function S(e,t){let r=await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t.email).first();if(r)return r.id;let a=(0,n.Z)();return await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(a,t.email).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(a,t.email).run(),a}async function f(e,t){let r=c(e),a=await r.createSession(t,{}),i=r.createSessionCookie(a.id).serialize();return{session:a,cookie:i}}}},e=>{var t=t=>e(e.s=t);e.O(0,[776,481,745],()=>t(2279));var r=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/auth/google/route"]=r}]);
//# sourceMappingURL=route.js.map