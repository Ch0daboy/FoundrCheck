(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[884],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},4111:(e,t,a)=>{"use strict";a.r(t),a.d(t,{ComponentMod:()=>_,default:()=>k});var r={};a.r(r),a.d(r,{POST:()=>p,runtime:()=>c});var i={};a.r(i),a.d(i,{originalPathname:()=>S,patchFetch:()=>R,requestAsyncStorage:()=>w,routeModule:()=>E,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var n=a(6637),s=a(1554),o=a(2130),u=a(7425),d=a(4381),l=a(4325);let c="edge";async function p(e){let t=(0,d.O)(),a=new URL(e.url).pathname.split("/").pop();if("register"===a){let a=await e.json(),r=a?.email,i=a?.password;if(!r||!i)return new Response("Bad request",{status:400});let{userId:n,cookie:s}=await (0,l.ye)(t,r,i);return new Response(JSON.stringify({userId:n}),{status:201,headers:{"Set-Cookie":s}})}if("login"===a){let a=await e.json(),r=a?.email,i=a?.password;if(!r||!i)return new Response("Bad request",{status:400});try{let{cookie:e}=await (0,l.WI)(t,r,i);return new Response(JSON.stringify({ok:!0}),{headers:{"Set-Cookie":e}})}catch{return new Response("Invalid credentials",{status:401})}}return"logout"===a?new Response("",{headers:{"Set-Cookie":await (0,l.kS)(t,e)}}):new Response("Not found",{status:404})}let E=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/[...lucia]/route",pathname:"/api/auth/[...lucia]",filename:"route",bundlePath:"app/api/auth/[...lucia]/route"},resolvedPagePath:"/home/noob/FoundrCheck/app/api/auth/[...lucia]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:h}=E,S="/api/auth/[...lucia]/route";function R(){return(0,u.XH)({serverHooks:h,staticGenerationAsyncStorage:f})}let _=i,k=n.a.wrap(E)},4381:(e,t,a)=>{"use strict";a.d(t,{O:()=>i});var r=a(6493);function i(){return(0,r.getRequestContext)().env}},4325:(e,t,a)=>{"use strict";a.d(t,{Gl:()=>c,WI:()=>E,hE:()=>h,kS:()=>w,vt:()=>l,y_:()=>f,ye:()=>p});var r=a(2813),i=a(3611),n=a(9560),s=a(129);async function o(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function u(e,t){return await o(t)===e}function d(e){let t=new i.rs(e.DB,{user:"user",session:"session"}),a=(e.APP_URL||"https://foundrcheck.com").includes("foundrcheck.com");return new r.aF(t,{sessionExpiresIn:new r.i9(30,"d"),sessionCookie:{name:"fc_session",attributes:{sameSite:"lax",secure:a,path:"/",domain:a?".foundrcheck.com":void 0}}})}function l(e){if(!e.GOOGLE_CLIENT_ID||!e.GOOGLE_CLIENT_SECRET)throw Error("Google OAuth credentials not configured");let t=`${e.APP_URL||"https://foundrcheck.com"}/api/auth/google/callback`;return new n.ie(e.GOOGLE_CLIENT_ID,e.GOOGLE_CLIENT_SECRET,t)}async function c(e,t){let a=d(e),r=t.headers.get("cookie")??"",i=a.readSessionCookie(r);return i?await a.validateSession(i):{user:null,session:null}}async function p(e,t,a){if(await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t).first())throw Error("EMAIL_TAKEN");let r=(0,s.Z)();await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(r,t).run();let i=await o(a),n=`email:${t}`;await e.DB.prepare("INSERT INTO key (id, user_id, hashed_password) VALUES (?, ?, ?)").bind(n,r,i).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(r,t).run();let u=d(e),l=await u.createSession(r,{});return{userId:r,cookie:u.createSessionCookie(l.id).serialize()}}async function E(e,t,a){let r=`email:${t}`,i=await e.DB.prepare("SELECT user_id, hashed_password FROM key WHERE id = ?").bind(r).first();if(!i||!await u(i.hashed_password,a))throw Error("INVALID_CREDENTIALS");let n=d(e),s=await n.createSession(i.user_id,{}),o=n.createSessionCookie(s.id).serialize();return{userId:i.user_id,cookie:o}}async function w(e,t){let a=d(e),r=t.headers.get("cookie")??"",i=a.readSessionCookie(r);return i&&await a.invalidateSession(i),a.createBlankSessionCookie().serialize()}async function f(e,t){let a=await e.DB.prepare("SELECT id FROM user WHERE email = ?").bind(t.email).first();if(a)return a.id;let r=(0,s.Z)();return await e.DB.prepare("INSERT INTO user (id, email) VALUES (?, ?)").bind(r,t.email).run(),await e.DB.prepare("INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)").bind(r,t.email).run(),r}async function h(e,t){let a=d(e),r=await a.createSession(t,{}),i=a.createSessionCookie(r.id).serialize();return{session:r,cookie:i}}}},e=>{var t=t=>e(e.s=t);e.O(0,[776,481,745],()=>t(4111));var a=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/auth/[...lucia]/route"]=a}]);
//# sourceMappingURL=route.js.map