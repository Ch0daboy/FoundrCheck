{"version":3,"file":"app/api/auth/[...lucia]/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/auth/[...lucia]/route.ts","webpack://_N_E/./app/api/auth/[...lucia]/route.ts?8210","webpack://_N_E/?6526","webpack://_N_E/./lib/env.ts","webpack://_N_E/./lib/lucia.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","import { env as getEnv } from \"@/lib/env\";\nimport { loginWithEmailPassword, logout, registerWithEmailPassword } from \"@/lib/lucia\";\n\nexport const runtime = \"edge\";\n\nexport async function POST(req: Request) {\n  const env = getEnv();\n  const url = new URL(req.url);\n  const action = url.pathname.split(\"/\").pop();\n  // minimal custom session handling\n\n  if (action === \"register\") {\n    const body = (await req.json()) as any;\n    const email = body?.email as string | undefined;\n    const password = body?.password as string | undefined;\n    if (!email || !password) return new Response(\"Bad request\", { status: 400 });\n    const { userId, cookie } = await registerWithEmailPassword(env, email, password);\n    return new Response(JSON.stringify({ userId }), {\n      status: 201,\n      headers: { \"Set-Cookie\": cookie },\n    });\n  }\n\n  if (action === \"login\") {\n    const body = (await req.json()) as any;\n    const email = body?.email as string | undefined;\n    const password = body?.password as string | undefined;\n    if (!email || !password) return new Response(\"Bad request\", { status: 400 });\n    try {\n      const { cookie } = await loginWithEmailPassword(env, email, password);\n      return new Response(JSON.stringify({ ok: true }), {\n        headers: { \"Set-Cookie\": cookie },\n      });\n    } catch {\n      return new Response(\"Invalid credentials\", { status: 401 });\n    }\n  }\n\n  if (action === \"logout\") {\n    const blank = await logout(env, req);\n    return new Response(\"\", { headers: { \"Set-Cookie\": blank } });\n  }\n\n  return new Response(\"Not found\", { status: 404 });\n}\n\n\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/home/noob/FoundrCheck/app/api/auth/[...lucia]/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/auth/[...lucia]/route\",\n        pathname: \"/api/auth/[...lucia]\",\n        filename: \"route\",\n        bundlePath: \"app/api/auth/[...lucia]/route\"\n    },\n    resolvedPagePath: \"/home/noob/FoundrCheck/app/api/auth/[...lucia]/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/auth/[...lucia]/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fauth%2F%5B...lucia%5D%2Froute&page=%2Fapi%2Fauth%2F%5B...lucia%5D%2Froute&pagePath=private-next-app-dir%2Fapi%2Fauth%2F%5B...lucia%5D%2Froute.ts&appDir=%2Fhome%2Fnoob%2FFoundrCheck%2Fapp&appPaths=%2Fapi%2Fauth%2F%5B...lucia%5D%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/auth/[...lucia]/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","import { getRequestContext } from \"@cloudflare/next-on-pages\";\n\nexport type Bindings = {\n  DB: D1Database;\n  IDEA_QUEUE: Queue;\n  PERPLEXITY_API_KEY: string;\n  PERPLEXITY_MODEL: string;\n  APP_TIMEZONE?: string;\n  RATE_LIMIT_DAILY?: string | number;\n  TURNSTILE_SECRET_KEY?: string;\n  NEXT_PUBLIC_TURNSTILE_SITE_KEY?: string;\n};\n\nexport function env(): Bindings {\n  return getRequestContext().env as unknown as Bindings;\n}\n\n\n","import { Lucia, TimeSpan } from \"lucia\";\nimport { D1Adapter } from \"@lucia-auth/adapter-sqlite\";\nimport type { Bindings } from \"@/lib/env\";\nimport { v4 as uuidv4 } from \"uuid\";\n\n// Simple SHA-256 hashing for edge runtime compatibility\nasync function hashPassword(password: string): Promise<string> {\n  const data = new TextEncoder().encode(password);\n  const digest = await crypto.subtle.digest(\"SHA-256\", data);\n  const bytes = Array.from(new Uint8Array(digest));\n  return bytes.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\nasync function verifyPassword(hashedPassword: string, password: string): Promise<boolean> {\n  const hashed = await hashPassword(password);\n  return hashed === hashedPassword;\n}\n\nexport function createLucia(env: Bindings) {\n  const adapter = new D1Adapter(env.DB, { user: \"user\", session: \"session\" });\n  const lucia = new Lucia(adapter, {\n    sessionExpiresIn: new TimeSpan(30, \"d\"),\n    sessionCookie: {\n      name: \"fc_session\",\n      attributes: {\n        sameSite: \"lax\",\n        secure: true,\n        path: \"/\",\n      },\n    },\n  });\n  return lucia;\n}\n\nexport async function validateRequest(env: Bindings, req: Request) {\n  const lucia = createLucia(env);\n  const cookieHeader = req.headers.get(\"cookie\") ?? \"\";\n  const sessionId = lucia.readSessionCookie(cookieHeader);\n  if (!sessionId) return { user: null, session: null } as const;\n  return await lucia.validateSession(sessionId);\n}\n\nexport async function registerWithEmailPassword(env: Bindings, email: string, password: string) {\n  // Ensure email not taken\n  const exists = await env.DB.prepare(\"SELECT id FROM user WHERE email = ?\").bind(email).first();\n  if (exists) throw new Error(\"EMAIL_TAKEN\");\n\n  const userId = uuidv4();\n  await env.DB.prepare(\"INSERT INTO user (id, email) VALUES (?, ?)\").bind(userId, email).run();\n\n  const hashedPassword = await hashPassword(password);\n  const keyId = `email:${email}`;\n  await env.DB.prepare(\"INSERT INTO key (id, user_id, hashed_password) VALUES (?, ?, ?)\")\n    .bind(keyId, userId, hashedPassword)\n    .run();\n\n  await env.DB.prepare(\"INSERT OR IGNORE INTO user_profiles (id, email) VALUES (?, ?)\").bind(userId, email).run();\n\n  const lucia = createLucia(env);\n  const session = await lucia.createSession(userId, {});\n  const cookie = lucia.createSessionCookie(session.id).serialize();\n  return { userId, cookie } as const;\n}\n\nexport async function loginWithEmailPassword(env: Bindings, email: string, password: string) {\n  const keyId = `email:${email}`;\n  const row = await env.DB.prepare(\"SELECT user_id, hashed_password FROM key WHERE id = ?\")\n    .bind(keyId)\n    .first<{ user_id: string; hashed_password: string }>();\n  if (!row) throw new Error(\"INVALID_CREDENTIALS\");\n\n  const ok = await verifyPassword(row.hashed_password, password);\n  if (!ok) throw new Error(\"INVALID_CREDENTIALS\");\n\n  const lucia = createLucia(env);\n  const session = await lucia.createSession(row.user_id, {});\n  const cookie = lucia.createSessionCookie(session.id).serialize();\n  return { userId: row.user_id, cookie } as const;\n}\n\nexport async function logout(env: Bindings, req: Request) {\n  const lucia = createLucia(env);\n  const cookieHeader = req.headers.get(\"cookie\") ?? \"\";\n  const sessionId = lucia.readSessionCookie(cookieHeader);\n  if (sessionId) await lucia.invalidateSession(sessionId);\n  const blank = lucia.createBlankSessionCookie().serialize();\n  return blank;\n}\n\n\n"],"names":["module","exports","require","runtime","POST","req","env","getEnv","action","url","URL","pathname","split","pop","body","json","email","password","Response","status","userId","cookie","registerWithEmailPassword","JSON","stringify","headers","loginWithEmailPassword","ok","logout","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fauth_2F_5B_lucia_5D_2Froute_ts_page_2Fapi_2Fauth_2F_5B_lucia_5D_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGYXV0aCUyRiU1Qi4uLmx1Y2lhJTVEJTJGcm91dGUmcGFnZT0lMkZhcGklMkZhdXRoJTJGJTVCLi4ubHVjaWElNUQlMkZyb3V0ZSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmF1dGglMkYlNUIuLi5sdWNpYSU1RCUyRnJvdXRlLnRzJmFwcERpcj0lMkZob21lJTJGbm9vYiUyRkZvdW5kckNoZWNrJTJGYXBwJmFwcFBhdGhzPSUyRmFwaSUyRmF1dGglMkYlNUIuLi5sdWNpYSU1RCUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getRequestContext","hashPassword","data","TextEncoder","encode","bytes","from","Uint8Array","crypto","subtle","digest","map","b","toString","padStart","join","verifyPassword","hashedPassword","hashed","createLucia","adapter","D1Adapter","DB","user","session","Lucia","sessionExpiresIn","TimeSpan","sessionCookie","name","attributes","sameSite","secure","path","validateRequest","lucia","cookieHeader","get","sessionId","readSessionCookie","validateSession","prepare","bind","first","uuidv4","run","keyId","createSession","createSessionCookie","id","serialize","row","hashed_password","user_id","invalidateSession","createBlankSessionCookie"],"sourceRoot":""}